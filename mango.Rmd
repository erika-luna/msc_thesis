---
title: "Mango"
author: "Erika Luna"
date: "21/10/2020"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width='950px', dpi=300)
```

This document explores the mango data from SIAP - Mexico.
- Data has been summarized at the state level.
- 26 states report mango production during the time period of 1980 - 2016.
- There are 962 observations total (26 states x 37 years), one observation/year for each state. 

```{r packages, echo=FALSE}
#Load packages
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(DT)
```

```{r load data}
SIAP <- read.csv("/Users/erikaluna/R\ Studio/msc_thesis/SIAP.csv") 
```

```{r irrigated}
mango_irri_state <- SIAP %>% 
  filter(state %in% c("baja california","baja california sur", "chihuahua", "durango", "nayarit", "sinaloa", "sonora"), year < 2002, crop == "mango", water == "irrigated") %>% 
  select(year, state, water, yield, losses)
#mango_irri_state %>% 
  #DT::datatable()

mango_irri_mun <- SIAP %>% 
  filter(state %in% c("baja california","baja california sur", "chihuahua", "durango", "nayarit", "sinaloa", "sonora"), year > 2001, crop == "mango", water == "irrigated") %>% 
  select(year, state, water, yield, losses)
mango_irri_mun %>% 
  DT::datatable()
```

```{r rainfed state}
mango_rain_state <- SIAP %>% 
  filter(state %in% c("baja california","baja california sur", "chihuahua", "durango", "nayarit", "sinaloa", "sonora"), year < 2002, crop == "mango", water == "rainfed") %>% 
  select(year, state, water, yield, losses)
#mango_rain_state %>% 
  #DT::datatable()
mango_rain_mun <- SIAP %>% 
  filter(state %in% c("baja california","baja california sur", "chihuahua", "durango", "nayarit", "sinaloa", "sonora"), year > 2001, crop == "mango", water == "rainfed") %>% 
  select(year, state, water, yield, losses)
mango_rain_mun %>% 
  DT::datatable()
```

```{r}
mango_water_state <- bind_rows(mango_irri_state, mango_rain_state)
mango_water_mun <- bind_rows(mango_irri_mun, mango_rain_mun)
```

```{r}
mango_water_state %>% 
  ggplot(aes(water, yield)) +
  geom_boxplot() +
  scale_y_continuous("Yield (ha)", trans = "log10") +
  ylab("Yield (ha)") +
  xlab("Water mode") +
  ggtitle("Mango State level")
  #scale_y_continuous(labels = comma) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```

```{r}
mango_water_mun %>% 
  ggplot(aes(water, yield)) +
  geom_boxplot() +
  scale_y_continuous("Yield (ha)", trans = "log10") +
  ylab("Yield (ha)") +
  xlab("Water mode") +
  ggtitle("Mango Municipal level")
  #scale_y_continuous(labels = comma) +
  #theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```

## Mango
```{r crop}
one_crop <- SIAP %>% 
  filter(crop == "mango") %>% 
  group_by(year, state) %>% 
  summarise(ag_yield = round(sum(production)/sum(harvested), digits = 2),
            ag_prod = sum(production),
            ag_planted = sum(planted),
            ag_harv = sum(harvested), 
            ag_losses = sum(losses))
```
## Mango national
```{r}
mango_nat <- SIAP %>% 
  filter(crop == "mango") %>% 
  #filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora"), crop == "mango") %>% 
  group_by(year) %>% 
  summarise(ag_yield = round(sum(production)/sum(harvested), digits = 2),
            ag_prod = sum(production),
            ag_planted = sum(planted),
            ag_harv = sum(harvested), 
            ag_losses = sum(losses))

mango_nat %>% 
  DT::datatable()
```

## Number of observations
```{r NAs, echo=FALSE}
crop_full <- one_crop %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_prod))) 

plot_obs <- crop_full %>% 
  ggplot(aes(state, obs)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(name = "number of observations") #+
  #ggtitle("NAs for production")
plot_obs
```





## Panel data
A data frama with all years and all states that grow mango.
```{r Panel}
period <- tibble(rep(c(1980:2016), times = 26)) #26 states report mango production
colnames(period) <- c("year") 
states <- tibble(rep(c("baja california", "baja california sur", "campeche", 
                       "chiapas", "colima", "durango",
                        "guanajuato", "guerrero", "hidalgo", "jalisco", 
                       "mexico", "michoacan", "morelos", "nayarit", "oaxaca", 
                       "puebla", "queretaro", "quintana roo",
                        "san luis potosi", "sinaloa", "sonora", "tabasco", 
                       "tamaulipas", "veracruz", "yucatan", "zacatecas"), times = 37))
colnames(states) <- c("state") 
states <- states %>% 
  arrange(state)
states_period <- cbind(states, period)
```


## Data frame for Mango
```{r Mango}
mango <- left_join(states_period, one_crop, by=c("state", "year"))
mango <- mango %>%  
  transform(i=as.numeric(factor(state))) %>% 
  transform(t=as.numeric(factor(year))) %>% 
  group_by(year) %>% 
  arrange(state) 

mango %>% 
  DT::datatable()
```


## Plots
### Production

```{r}
mango %>% 
  group_by(state) %>% 
  summarise(max_prod = max(ag_prod, na.rm=T),
            min_prod = min(ag_prod, na.rm=T),
            range_prod = max(ag_prod, na.rm=T) - min(ag_prod, na.rm=T),
            sd_prod = sd(ag_prod, na.rm=T),
            mean_prod = mean(ag_prod, na.rm=T),
            median_prod = median(ag_prod, na.rm=T)) %>% 
  knitr::kable()
```

```{r}
mango %>% 
  ggplot(aes(state, ag_prod)) +
  geom_boxplot() +
  ylab("Production (tonnes)") +
  xlab("State") +
  #scale_y_continuous(labels = comma) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```



```{r}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_prod)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_prod)) + 
  geom_line()+
  ylab("Production (tonnes)") +
  xlab("Years") +
  ggtitle("Mango Production 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```

### Yield
```{r}
mango %>% 
  group_by(state) %>% 
  summarise(max_yield = max(ag_yield, na.rm=T),
            min_yield = min(ag_yield, na.rm=T),
            range_yield = max(ag_yield, na.rm=T) - min(ag_yield, na.rm=T),
            sd_yield = sd(ag_yield, na.rm=T),
            mean_yield = mean(ag_yield, na.rm=T),
            median_yield = median(ag_yield, na.rm=T)) %>% 
  knitr::kable()
```

```{r}
mango %>% 
  ggplot(aes(state, ag_yield)) +
  geom_boxplot() +
  ylab("Yield (tonnes/ha)") +
  xlab("State") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```



```{r}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_yield)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_yield)) + 
  geom_line()+
  ylab("Yield (tonnes/ha)") +
  xlab("Years") +
  ggtitle("Mango Yields 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```

### Area
```{r}
mango %>% 
  group_by(state) %>% 
  summarise(max_area = max(ag_harv, na.rm=T),
            min_area = min(ag_harv, na.rm=T),
            range_area = max(ag_harv, na.rm=T) - min(ag_harv, na.rm=T),
            sd_area = sd(ag_harv, na.rm=T),
            mean_area = mean(ag_harv, na.rm=T),
            median_area = median(ag_harv, na.rm=T)) %>% 
  knitr::kable()
```

```{r}
mango %>% 
  ggplot(aes(state, ag_harv)) +
  geom_boxplot() +
  ylab("Area (tonnes)") +
  xlab("State") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```



```{r}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_harv)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_harv)) + 
  geom_line()+
  ylab("Area harvested (ha)") +
  xlab("Years") +
  ggtitle("Mango - Area Harvested (ha) 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```




## Yields ~ Time
# Mango trends at the national level
```{r country - yields - years}
m <- mango_nat %>% 
  ggplot(aes(year, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  stat_cor()+
  #scale_y_continuous(trans = 'log10')+
  #annotation_logticks(sides="lb")+
  ylab("Yield (tonnes/ha)") +
  xlab("Years") +
  ggtitle("MANGO Yields from 1980 to 2016")# +
  #theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
m
```
# Mango trends at the state level
```{r state - yields - years}
lt <- mango %>% 
  ggplot(aes(year, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ylab("Yields (tonnes/ha)") +
  xlab("Years") +
  ggtitle("Mango Yields") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
lt
```



## Yields ~ Temperature
```{r load temp}
tmax_summary <- read.csv("/Users/erikaluna/R\ Studio/climate_data/tmax_summary.csv")
tmin_summary <- read.csv("/Users/erikaluna/R\ Studio/climate_data/tmin_summary.csv")
```

```{r mango - temp}
mango_tmax <- left_join(mango, tmax_summary, by = c("state" = "state", "year" = "year"))
mango_tmin <- left_join(mango, tmin_summary, by = c("state" = "state", "year" = "year"))
```

# Mango yields ~ temperature at the national level

```{r country - yields - tmax}
yt <- mango_tmax %>% 
  ggplot(aes(mean_tmax, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ylab("Yield (tonnes/ha)") +
  xlab("Temperature (ºC) ") +
  ggtitle("Mango Yields ~ Max Temperature")
yt
```

```{r country - yields - tmin}
yt <- mango_tmin %>% 
  ggplot(aes(mean_tmin, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ylab("Yield (tonnes/ha)") +
  xlab("Temperature (ºC) ") +
  ggtitle("Mango Yields ~ Min Temperature") #+
yt
```


```{r states - yields - tmax}
mango_lm <- mango_tmax %>% 
  filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora")) %>% 
  ggplot(aes(mean_tmax, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  #scale_y_continuous(trans = 'log10')+
  ggtitle("mango Yields") +
   ylab("Yield (tonnes/ha)") +
  xlab("Temperature (ºC) ") +
  ggtitle("Mango Yields ~ Max Temperature") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  facet_wrap(~state, scales="free_y") 
mango_lm
```
```{r states - yields - tmin}
mango_lm <- mango_tmin %>% 
  filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora")) %>% 
  ggplot(aes(mean_tmin, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ylab("Yield (tonnes/ha)") +
  xlab("Temperature (ºC)") +
  #scale_y_continuous(trans = 'log10')+
  ggtitle("Mango Yields ~ Min Temperature") +
  facet_wrap(~state, scales="free_y") 
mango_lm
```

