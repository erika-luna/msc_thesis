---
title: "Mango"
author: "Erika Luna"
date: "21/10/2020"
output: 
  html_document:
    keep_md: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, out.width='950px', dpi=300)
```

## R mark
This document explores the mango data from SIAP - Mexico.
- Data has been summarized at the state level.
- 26 states report mango production during the time period of 1980 - 2016.
- There are 962 observations total (26 states x 37 years), one observation/year for each state. 


```{r packages, echo=FALSE}
#Load packages
library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(DT)
```

```{r load data}
SIAP <- read.csv("/Users/erikaluna/R\ Studio/msc_thesis/SIAP.csv") 
```


## Mango
```{r crop}
one_crop <- SIAP %>% 
  filter(crop == "mango") %>% 
  group_by(year, state) %>% 
  summarise(ag_yield = round(sum(production)/sum(harvested), digits = 2),
            ag_prod = sum(production),
            ag_planted = sum(planted),
            ag_harv = sum(harvested), 
            ag_losses = sum(losses))
```


## Number of observations
```{r NAs, echo=FALSE}
crop_full <- one_crop %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_prod))) 

plot_obs <- crop_full %>% 
  ggplot(aes(state, obs)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) +
  scale_y_continuous(name = "number of observations") #+
  #ggtitle("NAs for production")
plot_obs
```





## Panel data
A data frama with all years and all states that grow mango.
```{r Panel}
period <- tibble(rep(c(1980:2016), times = 26)) #26 states report mango production
colnames(period) <- c("year") 
states <- tibble(rep(c("baja california", "baja california sur", "campeche", 
                       "chiapas", "colima", "durango",
                        "guanajuato", "guerrero", "hidalgo", "jalisco", 
                       "mexico", "michoacan", "morelos", "nayarit", "oaxaca", 
                       "puebla", "queretaro", "quintana roo",
                        "san luis potosi", "sinaloa", "sonora", "tabasco", 
                       "tamaulipas", "veracruz", "yucatan", "zacatecas"), times = 37))
colnames(states) <- c("state") 
states <- states %>% 
  arrange(state)
states_period <- cbind(states, period)
```


## Data frame for Mango
```{r Mango}
mango <- left_join(states_period, one_crop, by=c("state", "year"))
mango <- mango %>%  
  transform(i=as.numeric(factor(state))) %>% 
  transform(t=as.numeric(factor(year))) %>% 
  group_by(year) %>% 
  arrange(state) 

mango %>% 
  DT::datatable()
```


## Plots
### Production

```{r}
mango %>% 
  group_by(state) %>% 
  summarise(max_prod = max(ag_prod, na.rm=T),
            min_prod = min(ag_prod, na.rm=T),
            range_prod = max(ag_prod, na.rm=T) - min(ag_prod, na.rm=T),
            sd_prod = sd(ag_prod, na.rm=T),
            mean_prod = mean(ag_prod, na.rm=T),
            median_prod = median(ag_prod, na.rm=T)) %>% 
  knitr::kable()
```

```{r}
mango %>% 
  ggplot(aes(state, ag_prod)) +
  geom_boxplot() +
  ylab("Production (tonnes)") +
  xlab("State") +
  #scale_y_continuous(labels = comma) +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```



```{r}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_prod)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_prod)) + 
  geom_line()+
  ylab("Production (tonnes)") +
  xlab("Years") +
  ggtitle("Mango Production 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```

### Yield
```{r}
mango %>% 
  group_by(state) %>% 
  summarise(max_yield = max(ag_yield, na.rm=T),
            min_yield = min(ag_yield, na.rm=T),
            range_yield = max(ag_yield, na.rm=T) - min(ag_yield, na.rm=T),
            sd_yield = sd(ag_yield, na.rm=T),
            mean_yield = mean(ag_yield, na.rm=T),
            median_yield = median(ag_yield, na.rm=T)) %>% 
  knitr::kable()
```

```{r}
mango %>% 
  ggplot(aes(state, ag_yield)) +
  geom_boxplot() +
  ylab("Yield (tonnes/ha)") +
  xlab("State") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```



```{r}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_yield)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_yield)) + 
  geom_line()+
  ylab("Yield (tonnes/ha)") +
  xlab("Years") +
  ggtitle("Mango Yields 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```

### Area
```{r}
mango %>% 
  group_by(state) %>% 
  summarise(max_area = max(ag_harv, na.rm=T),
            min_area = min(ag_harv, na.rm=T),
            range_area = max(ag_harv, na.rm=T) - min(ag_harv, na.rm=T),
            sd_area = sd(ag_harv, na.rm=T),
            mean_area = mean(ag_harv, na.rm=T),
            median_area = median(ag_harv, na.rm=T)) %>% 
  knitr::kable()
```

```{r}
mango %>% 
  ggplot(aes(state, ag_harv)) +
  geom_boxplot() +
  ylab("Area (tonnes)") +
  xlab("State") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```



```{r}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_harv)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_harv)) + 
  geom_line()+
  ylab("Area harvested (ha)") +
  xlab("Years") +
  ggtitle("Mango - Area Harvested (ha) 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```

### Losses
```{r losses, eval=FALSE, include=FALSE}
#mango %>% 
 # group_by(state) %>% 
  #summarise(max_losses = max(ag_losses, na.rm=T),
   #         min_losses = min(ag_losses, na.rm=T),
    #        range_losses = max(ag_losses, na.rm=T) - min(ag_losses, na.rm=T),
     #       sd_losses = sd(ag_losses, na.rm=T),
      #     median_losses = median(ag_losses, na.rm=T)) %>% 
  #knitr::kable()
```

```{r losses boxplot, eval=FALSE, include=FALSE}
mango %>% 
  ggplot(aes(state, ag_losses)) +
  geom_boxplot() +
  ylab("Losses (ha)") +
  xlab("State") +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust= 0.5))
```

```{r losses time series, eval=FALSE, include=FALSE}
number_obs <- mango %>% 
  group_by(state) %>% 
  summarise(obs = sum(!is.na(ag_losses)))

mango_complete <- number_obs %>% 
  filter(obs > 34)
mango_complete

mango_ts <- mango %>% 
  ggplot(aes(year, ag_losses)) + 
  geom_line()+
  ylab("Losses (ha)") +
  xlab("Years") +
  ggtitle("Mango - Losses (planted-harvested) (ha) 1980 - 2016") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
  #facet_wrap(~state, ncol=5)
mango_ts  
```

Regression line
```{r}
mango_lm <- mango %>% 
  ggplot(aes(year, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ylab("Yield (tonnes/ha)") +
  xlab("Years") +
  ggtitle("mango Yields") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  geom_rect(data = subset(mango, state %in% c(mango_complete$state)), 
            fill = NA, colour = "red", xmin = -Inf,xmax = Inf,
            ymin = -Inf,ymax = Inf) +     
  facet_wrap(~state, scales="free_y", ncol=5) 
mango_lm
```

```{r load temp}
tmax_summary <- read.csv("/Users/erikaluna/R\ Studio/climate_data/tmax_summary.csv")
tmin_summary <- read.csv("/Users/erikaluna/R\ Studio/climate_data/tmin_summary.csv")
  
```

```{r}
#yields_tmax <- dplyr::inner_join(mango, tmax_summary, by = "state")
yields_tmax <- left_join(mango, tmax_summary, by = c("state" = "state", "year" = "year"))
yield_tmin <- left_join(mango, tmin_summary, by = c("state" = "state", "year" = "year"))
```

```{r}
mango_yields_temp <- yields_tmax %>% 
  filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora")) %>% 
  ggplot(aes(mean_tmax, ag_yield)) + 
  geom_point() +
  facet_wrap(~state, scales="free_y") 
mango_yields_temp
```
```{r}
mango_yields_tmin <- yield_tmin %>% 
  filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora")) %>% 
  ggplot(aes(mean_tmin, ag_yield)) + 
  geom_point() +
  facet_wrap(~state, scales="free_y") 
mango_yields_tmin
```

```{r}
mango_lm <- yields_tmax %>% 
  filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora")) %>% 
  ggplot(aes(mean_tmax, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ggtitle("mango Yields") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  facet_wrap(~state, scales="free_y") 
mango_lm
```
```{r}
mango_lm <- yield_tmin %>% 
  filter(state %in% c("baja california sur", "durango", "nayarit", "sinaloa", "sonora")) %>% 
  ggplot(aes(mean_tmin, ag_yield)) + 
  geom_point() +
  geom_smooth(method = "lm", se = T) +
  ggtitle("mango Yields") +
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1)) +
  facet_wrap(~state, scales="free_y") 
mango_lm
```
